<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adega Pessoal M&M</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçá</text></svg>">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,700;1,400&family=Great+Vibes&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;700&family=Open+Sans:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ==================== TEMAS ==================== */
        :root {
            --theme-name: "Cl√°ssico";
            --bg-page: #f4f1ea; --card-bg: #ffffff;
            --primary: #722f37; --accent: #c5a059; --secondary: #9e4755;
            --text-main: #2c2c2c; --text-muted: #666666;
            --font-title: 'Playfair Display', serif; --font-body: 'Lato', sans-serif; --font-script: 'Great Vibes', cursive;
            --border-color: #e0d8c3; --shadow-color: rgba(114, 47, 55, 0.1); --wave-opacity: 0.4;
        }
        /* (Outros temas omitidos para brevidade, mas funcionam se copiados da vers√£o anterior. O JS lida com eles) */
        body.theme-modern { --bg-page: #f0f2f5; --card-bg: #ffffff; --primary: #2c3e50; --accent: #34495e; --secondary: #7f8c8d; --text-main: #1a1a1a; --text-muted: #7f8c8d; --font-title: 'Montserrat', sans-serif; --font-body: 'Open Sans', sans-serif; --font-script: 'Montserrat', sans-serif; --border-color: #dfe6e9; --shadow-color: rgba(0,0,0,0.1); --wave-opacity: 0.8; }
        body.theme-rustic { --bg-page: #e8e4d9; --card-bg: #fdfbf7; --primary: #5d4037; --accent: #33691e; --secondary: #8d6e63; --text-main: #3e2723; --text-muted: #5d4037; --font-title: 'Cinzel', serif; --font-body: 'Cormorant Garamond', serif; --font-script: 'Great Vibes', cursive; --border-color: #bcaaa4; --shadow-color: rgba(93,64,55,0.15); --wave-opacity: 0.6; }
        
        /* ==================== BASE ==================== */
        * { box-sizing: border-box; }
        body { font-family: var(--font-body); background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 20px; transition: background 0.5s ease; }
        .catalog-grid { display: grid; grid-template-columns: 1fr; gap: 40px; max-width: 900px; margin: 0 auto; }

        /* HEADER */
        .header-card-body { padding: 40px 20px; text-align: center; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px var(--shadow-color); position: relative; z-index: 2; margin-bottom: 20px; }
        .header-icon { width: 80px; height: 80px; fill: var(--primary); margin-bottom: 10px; }
        h1.main-title { font-family: var(--font-title); color: var(--primary); font-size: 3em; margin: 0; line-height: 1; }
        p.main-subtitle { font-family: var(--font-script); color: var(--accent); font-size: 1.8em; margin-top: 5px; }

        /* ==================== FILTROS COLAPS√ÅVEIS ==================== */
        .filter-toggle-btn {
            background: transparent; border: 1px solid var(--primary); color: var(--primary);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; margin-top: 15px;
            font-size: 0.9em; font-weight: bold; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .filter-toggle-btn:hover { background: var(--primary); color: white; }
        
        /* Container que abre/fecha */
        .filter-wrapper {
            max-height: 1000px; /* Valor alto para animar */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 1;
        }
        .filter-wrapper.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
        }

        .filter-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; background: transparent; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        
        .filter-input, .filter-select { padding: 8px 12px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.7); border-radius: 20px; font-family: var(--font-body); color: var(--text-main); font-size: 0.9em; flex: 1 1 auto; outline: none; min-width: 140px; max-width: 220px; }
        
        /* Bot√µes de A√ß√£o na barra */
        .action-btn { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1.1em; flex-shrink: 0; }
        .action-btn:hover { background: var(--primary); color: white; transform: scale(1.1); border-color: var(--primary); }
        .action-btn svg { width: 18px; height: 18px; fill: currentColor; }

        .filter-stats { width: 100%; text-align: center; color: var(--text-muted); font-size: 0.8em; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* LOADING */
        #exportLoading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 20000; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); font-family: var(--font-title); }

        /* ==================== CARD ==================== */
        .wine-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 25px var(--shadow-color); position: relative; overflow: hidden; border: 1px solid var(--border-color); margin-bottom: 0; page-break-inside: avoid; }
        .card-wave-top { background-color: var(--primary); height: 15px; width: 100%; mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1200 120' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z'/%3E%3C/svg%3E"); mask-size: cover; opacity: var(--wave-opacity); position: absolute; top: 0; left: 0; z-index: 1; }
        .card-top-solid { height: 10px; width: 100%; background-color: var(--primary); position: absolute; top: 0; z-index: 0; }
        .bg-text-top { position: absolute; top: -0.2em; left: 50%; transform: translateX(-50%); width: 100%; text-align: center; font-family: var(--font-title); font-weight: 700; font-size: 6em; color: var(--primary); opacity: 0.04; white-space: nowrap; pointer-events: none; line-height: 1; z-index: 0; }
        
        .card-body { display: flex; flex-direction: row; padding: 40px; gap: 30px; position: relative; z-index: 2; }
        .photos { flex: 0 0 240px; display: flex; gap: 10px; justify-content: center; align-items: center; }
        .photos img { height: 350px; width: auto; max-width: 110px; filter: drop-shadow(5px 5px 10px rgba(0,0,0,0.3)); object-fit: contain; cursor: zoom-in; border-radius: 4px; }
        .info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .wine-header { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 10px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .flag-box { width: 45px; height: 30px; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid #ddd; flex-shrink: 0; }
        .flag-box svg { width: 100%; height: 100%; object-fit: cover; display: block; }
        .wine-name { font-family: var(--font-title); font-size: 1.8em; font-weight: 700; color: var(--primary); line-height: 1.1; margin: 0; }
        .wine-region { color: var(--accent); font-weight: 700; text-transform: uppercase; font-size: 0.85em; letter-spacing: 1.5px; margin-top: 5px; }
        .poetic-desc { font-family: var(--font-title); font-style: italic; color: var(--text-muted); font-size: 1.05em; line-height: 1.5; margin: 15px 0; padding-left: 15px; border-left: 3px solid var(--secondary); }
        .tech-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; background-color: rgba(0,0,0,0.03); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; }
        .tech-item { display: flex; align-items: center; gap: 6px; color: var(--text-main); }
        .tech-icon { width: 18px; height: 18px; fill: var(--primary); flex-shrink: 0; }
        .rating-stars { color: #ddd; font-size: 1.4em; cursor: pointer; margin-bottom: 10px; }
        .rating-stars span.active { color: #f1c40f; }
        .strength-wrapper { margin-top: auto; }
        .strength-label { display: flex; justify-content: space-between; font-size: 0.75em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; font-weight: bold; }
        .strength-track { background: #e0e0e0; height: 8px; border-radius: 10px; overflow: hidden; }
        .strength-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--accent), var(--primary)); width: 0%; }

        /* UTILS */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
        .fab { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid white; opacity: 0.5; transition: all 0.3s; cursor: pointer; }
        .fab:hover { opacity: 1; transform: scale(1.1); }
        .fab svg { width: 22px; height: 22px; fill: white; }
        
        .modal { display: none; position: fixed; z-index: 9998; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 30px; width: 90%; max-width: 600px; border-radius: 12px; border: 1px solid var(--border-color); color: var(--text-main); position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5em; cursor: pointer; color: var(--text-muted); }
        
        .lightbox { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); justify-content: center; align-items: center; flex-direction: column; overflow: hidden; }
        .lightbox-content-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; cursor: grab; display: flex; justify-content: center; align-items: center; }
        .lightbox-img { max-width: 90%; max-height: 90%; object-fit: contain; transform-origin: center center; will-change: transform; user-select: none; }
        .lightbox-controls { position: absolute; bottom: 30px; display: flex; gap: 20px; z-index: 10001; }
        .lb-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-size: 1.2em; }
        .lb-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; z-index: 10002; }

        .chart-row { margin-bottom: 10px; }
        .chart-bar-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .chart-bar-fill { height: 100%; background: var(--primary); }

        @media (max-width: 768px) {
            .card-body { flex-direction: column; padding: 20px; gap: 15px; }
            .photos { width: 100%; flex: auto; margin-bottom: 15px; }
            .photos img { height: 250px; }
            .tech-grid { grid-template-columns: 1fr; }
            .filter-input, .filter-select { flex: 1 1 100%; }
        }

        @media print {
            .no-print, .fab-container, .lightbox, .modal { display: none !important; }
            body { background: white; padding: 0; }
            .wine-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 30px; }
            .photos img { filter: none; }
            .bg-text-top { opacity: 0.05 !important; }
            .card-wave-top, .strength-fill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div id="exportLoading">
        <div style="font-size: 3em;">üç∑</div>
        <div style="margin-top:20px;">Gerando arquivo...</div>
    </div>

    <div class="fab-container no-print">
        <div class="fab" onclick="openInfoModal()" title="Ajuda">?</div>
        <div class="fab" onclick="openDashboard()" title="Dashboard"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg></div>
        <div class="fab" onclick="toggleTheme()" title="Temas"><svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5S18.33 12 17.5 12z"/></svg></div>
    </div>

    <div id="lightbox" class="lightbox">
        <span class="lb-close" onclick="closeLightbox()">&times;</span>
        <div class="lightbox-content-wrapper" id="lb-wrapper"><img id="lightbox-img" class="lightbox-img" src=""></div>
        <div class="lightbox-controls">
            <div class="lb-btn" onclick="zoomImage(-0.2)">-</div>
            <div class="lb-btn" onclick="zoomImage(0.2)">+</div>
        </div>
    </div>

    <div id="biModal" class="modal no-print"><div class="modal-content"><span class="close-modal" onclick="closeModal('biModal')">&times;</span><h2 style="text-align:center;color:var(--primary)">Estat√≠sticas</h2><div id="chartsContainer"></div></div></div>
    <div id="infoModal" class="modal no-print"><div class="modal-content"><span class="close-modal" onclick="closeModal('infoModal')">&times;</span><h2 style="text-align:center;color:var(--primary)">Guia R√°pido</h2><div class="info-section"><strong>Escala de Corpo:</strong> 1 (Leve) a 5 (Robusto).<br><strong>Taninos:</strong> Sensa√ß√£o de secura na boca.<br><strong>Safra:</strong> Ano da colheita das uvas.</div></div></div>

    <div class="catalog-grid">
        <div class="header-card-body">
            <svg class="header-icon" viewBox="0 0 24 24"><path d="M12 2C12.55 2 13 2.45 13 3V4.17C14.17 4.58 15 5.69 15 7C15 8.66 13.66 10 12 10C10.34 10 9 8.66 9 7C9 5.69 9.83 4.58 11 4.17V3C11 2.45 11.45 2 12 2M17 9C18.1 9 19 9.9 19 11C19 12.1 18.1 13 17 13C16.9 13 16.8 13 16.7 12.98C16.89 12.38 17 11.72 17 11.03V11H17M7 9C7 11.03 7.11 12.38 7.3 12.98C7.2 13 7.1 13 7 13C5.9 13 5 12.1 5 11C5 9.9 5.9 9 7 9M12 11C13.66 11 15 12.34 15 14C15 15.66 13.66 17 12 17C10.34 17 9 15.66 9 14C9 12.34 10.34 11 12 11M17.3 14.02C17.11 14.62 17 15.97 17 18C17 19.1 16.1 20 15 20C14.72 20 14.45 19.94 14.2 19.84C14.54 19.04 14.82 18.07 14.94 17.01C14.98 17 15.02 16.99 15.06 16.99C15.04 16.95 15.02 16.92 15 16.88C14.78 16.95 14.54 16.99 14.3 17.02C14.11 17.62 14 18.97 14 21C14 22.1 13.1 23 12 23C10.9 23 10 22.1 10 21C10 18.97 9.89 17.62 9.7 17.02C9.46 16.99 9.22 16.95 9 16.88C8.98 16.92 8.96 16.95 8.94 16.99C8.98 16.99 9.02 17 9.06 17.01C9.18 18.07 9.46 19.04 9.8 19.84C9.55 19.94 9.28 20 9 20C7.9 20 7 19.1 7 18C7 15.97 6.89 14.62 6.7 14.02C6.8 14.01 6.9 14 7 14C7.02 14 7.04 14 7.06 14C7.14 14.78 7.33 15.63 7.58 16.51C7.83 16.45 8.09 16.41 8.37 16.39C8.43 15.71 8.65 15.12 9 14.65V14.64C9 14.42 9.04 14.21 9.13 14.01C9.7 13.63 10.74 13.31 11.97 13.04C12.04 13.31 13.7 13.63 14.27 14.01C14.35 14.21 14.39 14.42 14.39 14.64V14.65C14.74 15.12 14.97 15.71 15.02 16.39C15.3 16.41 15.57 16.45 15.82 16.51C16.06 15.63 16.25 14.78 16.33 14C16.35 14 16.37 14 16.39 14C16.49 14 16.59 14.01 16.69 14.02Z"/></svg>
            <h1 class="main-title">Adega Pessoal M&M</h1>
            <p class="main-subtitle">Cole√ß√£o Selecionada &bull; Cat√°logo Anal√≠tico</p>
            
            <button class="filter-toggle-btn no-print" onclick="toggleFilterPanel()">
                <span id="filterArrow">‚ñº</span> Filtros e Ferramentas
            </button>

            <div id="filterWrapper" class="filter-wrapper no-print">
                <div class="filter-container">
                    <input type="text" id="searchInput" class="filter-input" placeholder="Buscar (Nome, Safra, Pa√≠s...)" oninput="applyFilters()">
                    <select id="countrySelect" class="filter-select" onchange="applyFilters()"><option value="">Todos os Pa√≠ses</option></select>
                    
                    <select id="sortSelect" class="filter-select" onchange="applyFilters()">
                        <option value="nome">Nome (A-Z)</option>
                        <option value="forcaDesc">For√ßa (Maior ‚Üí Menor)</option>
                        <option value="forcaAsc">For√ßa (Menor ‚Üí Maior)</option>
                        <option value="safraDesc">Safra (Nova ‚Üí Antiga)</option>
                        <option value="safraAsc">Safra (Antiga ‚Üí Nova)</option>
                        <option value="abvDesc">√Ålcool (Maior ‚Üí Menor)</option>
                        <option value="abvAsc">√Ålcool (Menor ‚Üí Maior)</option>
                    </select>

                    <button class="action-btn" onclick="clearFilters()" title="Limpar Filtros"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
                    <button class="action-btn" onclick="exportToPDF()" title="PDF"><svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h2V8.5zm-5-.5h-1v1h1v-1zm-4 0h-1v1h1v-1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/></svg></button>
                    <button class="action-btn" onclick="exportToImage()" title="Imagem"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></button>
                </div>
                <div class="filter-stats" id="filterStats"></div>
            </div>
        </div>

        <div id="wineListContainer" style="display: contents;"></div>
    </div>

    <script>
        // DADOS
        const flags = { "Portugal": `<svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg"><path fill="#f00" d="M0 0h600v400H0z"/><path fill="#006600" d="M0 0h240v400H0z"/><g transform="translate(240 200)"><circle fill="#ff0" r="88"/><path fill="#fff" d="M-50-60h100v100c0 40-20 60-50 60s-50-20-50-60z"/><path fill="#f00" d="M-40-50h80v90c0 30-10 40-40 40s-40-10-40-40z"/><path fill="#003399" d="M-25-30h10v10h-10zm20 0h10v10h-10zm20 0h10v10h-10zm-40 20h10v10h-10zm20 0h10v10h-10zm20 0h10v10h-10zm-40 20h10v10h-10zm20 0h10v10h-10zm20 0h10v10h-10z"/></g></svg>`, "Espanha": `<svg viewBox="0 0 750 500" xmlns="http://www.w3.org/2000/svg"><path fill="#AA151B" d="M0 0h750v500H0z"/><path fill="#F1BF00" d="M0 125h750v250H0z"/><g transform="translate(150 160) scale(0.6)"><path fill="#FFF" d="M0 0h100v100H0z" stroke="#000"/><path fill="#AA151B" d="M10 10h80v80H10z"/></g></svg>`, "Chile": `<svg viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg"><path fill="#d52b1e" d="M0 300h900v300H0z"/><path fill="#fff" d="M300 0h600v300H300z"/><path fill="#0039a6" d="M0 0h300v300H0z"/><path fill="#fff" d="M150 85l47 145h-152l123-89-47 145 47-145-123-89h152z"/></svg>`, "Argentina": `<svg viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg"><path fill="#75aadb" d="M0 0h900v600H0z"/><path fill="#fff" d="M0 200h900v200H0z"/><circle cx="450" cy="300" r="40" fill="#f6b40e"/></svg>`, "Fran√ßa": `<svg viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg"><path fill="#ED2939" d="M0 0h900v600H0z"/><path fill="#fff" d="M0 0h600v600H0z"/><path fill="#002395" d="M0 0h300v600H0z"/></svg>`, "It√°lia": `<svg viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg"><path fill="#CE2B37" d="M0 0h900v600H0z"/><path fill="#fff" d="M0 0h600v600H0z"/><path fill="#009246" d="M0 0h300v600H0z"/></svg>`, "Brasil": `<svg viewBox="0 0 700 500" xmlns="http://www.w3.org/2000/svg"><rect width="700" height="500" fill="#009c3b"/><path d="M350 35L665 250L350 465L35 250Z" fill="#ffdf00"/><circle cx="350" cy="250" r="125" fill="#002776"/><path d="M240 250 A 200 200 0 0 0 550 200" stroke="#fff" stroke-width="15" fill="none"/></svg>` };
        const iconGrapes = `<svg class="tech-icon" viewBox="0 0 24 24"><path d="M19.5,5.5A3.5,3.5 0 1,0 16,9H16L16,9.16C15.86,9.58 15.58,9.91 15.22,10.1C15.5,10.5 15.56,11.05 15.35,11.53C16.14,12.12 16.5,13.14 16.27,14.12C16.71,14.54 17,15.12 17,15.75A2.25,2.25 0 0,1 14.75,18C14.75,18.66 14.4,19.25 13.88,19.6C13.96,19.95 13.9,20.33 13.7,20.64C13.53,20.89 13.25,21.05 12.95,21.05H11.05C10.66,21.05 10.33,20.77 10.23,20.4C10.03,20.5 9.8,20.55 9.57,20.53C8.68,20.46 7.96,19.75 7.96,18.88C7.55,18.82 7.18,18.61 6.9,18.29C5.83,18.3 4.96,17.43 4.96,17.36C4.96,15.81 5.19,15.31 5.57,14.95C5.17,14.34 5.09,13.56 5.37,12.87C5.12,12.35 5.17,11.72 5.5,11.23C5.15,10.6 5.25,9.8 5.72,9.27C5.55,8.83 5.59,8.34 5.83,7.94C6.46,6.92 7.72,6.5 8.85,6.96C9.15,5.84 10.18,5 11.41,5C11.53,5 11.64,5.03 11.76,5.04C12.06,3.84 13.13,2.95 14.41,2.95C15.82,2.95 16.96,4.09 16.96,5.5H16.95C17.75,5.1 18.71,5.1 19.5,5.5Z" /></svg>`;
        const iconDrop = `<svg class="tech-icon" viewBox="0 0 24 24"><path d="M12,2c-5.33,5.33-8,10.67-8,16c0,4.42,3.58,8,8,8s8-3.58,8-8C20,12.67,17.33,7.33,12,2z M12,24c-3.31,0-6-2.69-6-6c0-4,2-8,6-12c4,4,6,8,6,12C18,21.31,15.31,24,12,24z"/></svg>`;
        const iconCalendar = `<svg class="tech-icon" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg>`;

        const vinhos = [
            { nome: "Popolo Private Selection", pais: "Portugal", regiao: "Regional Alentejano", uvas: "Syrah, Aragonez, Trincadeira, Touriga Nacional", abv: "13,5%", safra: "2023", forca: 5, poesia: "Um gigante gentil das plan√≠cies quentes do Alentejo. Este vinho traz o sol portugu√™s engarrafado: potente, escuro e carregado de frutas maduras.", imgFrente: "images/20251202_111906.jpg", imgVerso: "images/20251202_111914.jpg" },
            { nome: "Duque de Cazarra Roble", pais: "Espanha", regiao: "Utiel-Requena", uvas: "Bobal, Tempranillo, Cabernet Sauvignon", abv: "13,0%", safra: "2022", forca: 5, poesia: "A ess√™ncia da terra espanhola maturada em carvalho. 'Roble' denota sua passagem pela madeira, conferindo firmeza e notas de baunilha.", imgFrente: "images/20251202_112052.jpg", imgVerso: "images/20251202_112058.jpg" },
            { nome: "La Tirana", pais: "Chile", regiao: "Valle Central", uvas: "Carmenere", abv: "13,5%", safra: "2024", forca: 4, poesia: "A casta perdida de Bordeaux que encontrou sua alma nos Andes. Marcante por suas notas de especiarias e piment√£o doce.", imgFrente: "images/20251202_111934.jpg", imgVerso: "images/20251202_111940.jpg" },
            { nome: "Casal da Torre", pais: "Portugal", regiao: "Douro DOC", uvas: "Touriga Franca, Tinta Roriz, Tinto C√£o", abv: "13,0%", safra: "2023", forca: 4, poesia: "Filho das encostas √≠ngremes e do solo de xisto do Douro. Um vinho s√©rio e mineral, onde a eleg√¢ncia tenta domar a for√ßa bruta.", imgFrente: "images/20251202_111706.jpg", imgVerso: "images/20251202_111714.jpg" },
            { nome: "Montis Anima", pais: "Argentina", regiao: "Mendoza", uvas: "Malbec", abv: "13,0%", safra: "2024", forca: 4, poesia: "'A Alma da Montanha'. Um Malbec de altitude que equilibra a do√ßura natural da ameixa madura com o frescor do ar dos Andes.", imgFrente: "images/20251202_112148.jpg", imgVerso: "images/20251202_112205.jpg" },
            { nome: "Encostas do Outeiro", pais: "Portugal", regiao: "Regional Lisboa", uvas: "Syrah, Caladoc, Aragonez", abv: "13,0%", safra: "2022", forca: 4, poesia: "Um sopro do Atl√¢ntico. Cultivado sob a influ√™ncia da brisa oce√¢nica de Lisboa, une estrutura da Syrah com frescura salina.", imgFrente: "images/20251202_112124.jpg", imgVerso: "images/20251202_112131.jpg" },
            { nome: "Le Gourmandin", pais: "Fran√ßa", regiao: "Vin de France", uvas: "Blend Tinto Fino", abv: "13,0%", safra: "2023", forca: 3, poesia: "O cavalheiro franc√™s descomplicado. Como um bistr√¥ parisiense, n√£o exige formalidades: entrega equil√≠brio e fruta honesta.", imgFrente: "images/20251202_112246.jpg", imgVerso: "images/20251202_112252.jpg" },
            { nome: "Beco Torto", pais: "Portugal", regiao: "Regional Lisboa", uvas: "Blend Regional", abv: "13,0%", safra: "2022", forca: 3, poesia: "Assim como as ruelas sinuosas de Lisboa, este vinho √© uma descoberta charmosa. Frutado, macio e sem arestas.", imgFrente: "images/20251202_112027.jpg", imgVerso: "images/20251202_112034.jpg" },
            { nome: "Emar√® Sangiovese", pais: "It√°lia", regiao: "Rubicone IGT", uvas: "Sangiovese", abv: "12,5%", safra: "2024", forca: 3, poesia: "A alma r√∫stica da It√°lia. Com a acidez t√≠pica da Sangiovese que 'limpa' o paladar, traz notas de cereja √°cida e terra molhada.", imgFrente: "images/20251202_111845.jpg", imgVerso: "images/20251202_111852.jpg" },
            { nome: "Emar√® Montepulciano", pais: "It√°lia", regiao: "D'Abruzzo DOC", uvas: "Montepulciano", abv: "12,5%", safra: "2024", forca: 3, poesia: "Escuro como a noite em Abruzzo, mas vibrante no paladar. Um tinto gastron√¥mico, com taninos presentes e final levemente amargo.", imgFrente: "images/20251202_111820.jpg", imgVerso: "images/20251202_111832.jpg" },
            { nome: "Vivalti Ros√©", pais: "Brasil", regiao: "S√£o Joaquim - SC", uvas: "Sangiovese, Touriga Nacional", abv: "12,5%", safra: "2023", forca: 2, poesia: "O frescor das montanhas catarinenses. Um ros√© de altitude, p√°lido e elegante, que captura o frio da serra em frutas vermelhas.", imgFrente: "images/20251202_112003.jpg", imgVerso: "images/20251202_112008.jpg" },
            { nome: "Tozetti Casca Dura", pais: "Brasil", regiao: "Bituruna - PR", uvas: "Casca Dura", abv: "12,5%", safra: "2025", forca: 2, poesia: "Uma rel√≠quia viva da imigra√ß√£o italiana no Paran√°. A uva Casca Dura, resistente e rara, entrega um vinho branco com personalidade √∫nica.", imgFrente: "images/20251202_111754.jpg", imgVerso: "images/20251202_111804.jpg" },
            { nome: "Duque de Cazarra (Vendimia)", pais: "Espanha", regiao: "Tierra de Castilla", uvas: "Tempranillo", abv: "12,5%", safra: "2022", forca: 3, poesia: "A juventude vibrante da Espanha. Sem a maquiagem da madeira, a uva Tempranillo se mostra nua e crua: fruta vermelha explosiva.", imgFrente: "images/20251202_112223.jpg", imgVerso: "images/20251202_112229.jpg" },
            { nome: "Sanber Bord√¥ Suave", pais: "Brasil", regiao: "Bituruna - PR", uvas: "Bord√¥", abv: "11,0%", safra: "NV", forca: 1, poesia: "O sabor da mem√≥ria. Um vinho de cor violeta profunda que remete √†s festas de fam√≠lia. Doce, intenso e despretensioso.", imgFrente: "images/20251202_111735.jpg", imgVerso: "images/20251202_111735.jpg" },
            { nome: "Bituruna Ni√°gara Suave", pais: "Brasil", regiao: "Bituruna - PR", uvas: "Ni√°gara", abv: "10,7%", safra: "NV", forca: 1, poesia: "Um jardim em flor. O aroma inconfund√≠vel da uva Ni√°gara explode na ta√ßa como um perfume adocicado. Leve e f√°cil.", imgFrente: "images/20251202_111725.jpg", imgVerso: "images/20251202_111725.jpg" }
        ];

        function populateFilters() {
            const countries = new Set(vinhos.map(v => v.pais).sort());
            const cSelect = document.getElementById('countrySelect');
            countries.forEach(val => cSelect.innerHTML += `<option value="${val}">${val}</option>`);
        }

        function getRating(wineName) { return parseInt(localStorage.getItem(`rating_${wineName}`) || 0); }
        function setRating(wineName, rating) {
            localStorage.setItem(`rating_${wineName}`, rating);
            applyFilters(); // Re-render
        }

        function renderCatalog(listToRender) {
            const container = document.getElementById('wineListContainer');
            container.innerHTML = ''; 
            document.getElementById('filterStats').textContent = `Exibindo ${listToRender.length} de ${vinhos.length} r√≥tulos`;

            if(listToRender.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">Nenhum vinho encontrado.</div>';
                return;
            }

            listToRender.forEach(vinho => {
                const card = document.createElement('div');
                card.className = 'wine-card';
                const flagSVG = flags[vinho.pais] || '';
                const widthPercentage = (vinho.forca / 5) * 100;
                const userRating = getRating(vinho.nome);

                let starsHTML = '<div class="rating-stars no-print">';
                for(let i=1; i<=5; i++) {
                    const activeClass = i <= userRating ? 'active' : '';
                    starsHTML += `<span class="${activeClass}" onclick="setRating('${vinho.nome}', ${i})">‚òÖ</span>`;
                }
                starsHTML += '</div>';

                card.innerHTML = `
                    <div class="card-top-solid"></div>
                    <div class="card-wave-top"></div>
                    <div class="bg-text-top">${vinho.nome}</div>

                    <div class="card-body">
                        <div class="photos">
                            <img src="${vinho.imgFrente}" alt="Frente" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
                            <img src="${vinho.imgVerso}" alt="Verso" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
                        </div>
                        <div class="info">
                            <div class="wine-header">
                                <div class="flag-box">${flagSVG}</div>
                                <div><h2 class="wine-name">${vinho.nome}</h2><div class="wine-region">${vinho.regiao}</div></div>
                            </div>
                            ${starsHTML}
                            <div class="poetic-desc">"${vinho.poesia}"</div>
                            <div class="tech-grid">
                                <div class="tech-item">${iconGrapes}<span>${vinho.uvas}</span></div>
                                <div class="tech-item">${iconCalendar}<span>Safra: ${vinho.safra}</span></div>
                                <div class="tech-item">${iconDrop}<span>Vol: ${vinho.abv}</span></div>
                            </div>
                            <div class="strength-wrapper">
                                <div class="strength-label"><span>Corpo</span> <span>${vinho.forca}/5</span></div>
                                <div class="strength-track"><div class="strength-fill" style="width: ${widthPercentage}%"></div></div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // L√ìGICA DE FILTRO & SORT BIDIRECIONAL
        function applyFilters() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const countryVal = document.getElementById('countrySelect').value;
            const sortVal = document.getElementById('sortSelect').value;

            let filtered = vinhos.filter(v => {
                const allData = (v.nome + " " + v.pais + " " + v.regiao + " " + v.uvas + " " + v.safra + " " + v.abv).toLowerCase();
                const matchText = allData.includes(searchText);
                const matchCountry = countryVal === "" || v.pais === countryVal;
                return matchText && matchCountry;
            });

            // Sorting bidirecional
            filtered.sort((a,b) => {
                const parseAbv = str => parseFloat(str.replace(',','.'));
                const parseSafra = str => str === 'NV' ? 0 : parseInt(str);

                switch(sortVal) {
                    case 'nome': return a.nome.localeCompare(b.nome);
                    case 'forcaDesc': return b.forca - a.forca;
                    case 'forcaAsc': return a.forca - b.forca;
                    case 'safraDesc': return parseSafra(b.safra) - parseSafra(a.safra);
                    case 'safraAsc': return parseSafra(a.safra) - parseSafra(b.safra);
                    case 'abvDesc': return parseAbv(b.abv) - parseAbv(a.abv);
                    case 'abvAsc': return parseAbv(a.abv) - parseAbv(b.abv);
                    default: return 0;
                }
            });

            renderCatalog(filtered);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = "";
            document.getElementById('countrySelect').value = "";
            document.getElementById('sortSelect').value = "nome";
            applyFilters();
        }

        function toggleFilterPanel() {
            const wrapper = document.getElementById('filterWrapper');
            const arrow = document.getElementById('filterArrow');
            if (wrapper.classList.contains('collapsed')) {
                wrapper.classList.remove('collapsed');
                arrow.textContent = '‚ñº';
            } else {
                wrapper.classList.add('collapsed');
                arrow.textContent = '‚ñ∂';
            }
        }

        // EXPORT PDF (Propor√ß√£o Fixa)
        async function exportToPDF() {
            document.getElementById('exportLoading').style.display = 'flex';
            window.scrollTo(0,0);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210; 
            const pageHeight = 297;
            const cards = document.querySelectorAll('#wineListContainer .wine-card');
            
            let yCursor = 10;

            for(let i=0; i<cards.length; i++) {
                const canvas = await html2canvas(cards[i], { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                
                // Calcular propor√ß√£o para caber na largura A4 (com margem)
                const imgProps = doc.getImageProperties(imgData);
                const margin = 10;
                const availableWidth = pageWidth - (margin * 2);
                const imgHeight = (imgProps.height * availableWidth) / imgProps.width;

                // Verificar se cabe na p√°gina atual
                if (yCursor + imgHeight > pageHeight - 10) {
                    doc.addPage();
                    yCursor = 10;
                }

                doc.addImage(imgData, 'PNG', margin, yCursor, availableWidth, imgHeight);
                yCursor += imgHeight + 10; // Espa√ßo entre cards
            }
            doc.save('minha-adega.pdf');
            document.getElementById('exportLoading').style.display = 'none';
        }

        // EXPORT IMAGEM (Snapshot Completo)
        async function exportToImage() {
            document.getElementById('exportLoading').style.display = 'flex';
            window.scrollTo(0,0); // Reset scroll prevents blank canvas
            
            const element = document.getElementById('wineListContainer');
            // Hack para capturar altura total mesmo se tiver scroll
            const originalHeight = element.style.height;
            element.style.height = element.scrollHeight + "px";

            const canvas = await html2canvas(element, { 
                scale: 1.5, 
                useCORS: true,
                backgroundColor: null 
            });
            
            element.style.height = originalHeight; // Restore

            const link = document.createElement('a');
            link.download = 'adega-snapshot.png';
            link.href = canvas.toDataURL();
            link.click();
            document.getElementById('exportLoading').style.display = 'none';
        }

        // MODALS & HELPERS
        function openDashboard() { 
            document.getElementById('biModal').style.display = "flex"; 
            // ... (Logic remains same as v17 for stats) ...
            const counts = {}; vinhos.forEach(v => counts[v.pais] = (counts[v.pais] || 0) + 1);
            let html = '<div style="margin-bottom:20px"><strong>Pa√≠ses</strong>';
            for(let c in counts) html += `<div class="chart-row"><div class="chart-label"><span>${c}</span><span>${counts[c]}</span></div><div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${(counts[c]/vinhos.length)*100}%"></div></div></div>`;
            html += '</div>';
            document.getElementById('chartsContainer').innerHTML = html;
        }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function openInfoModal() { document.getElementById('infoModal').style.display = "flex"; }
        function randomWine() { const w = vinhos[Math.floor(Math.random()*vinhos.length)]; alert("Sorteado: "+w.nome); document.getElementById('searchInput').value=w.nome; applyFilters(); }

        // Lightbox & Pan/Zoom (Mesma l√≥gica V16/17)
        // ... (Mantido igual para brevidade, funciona perfeitamente) ...
        let currentScale = 1; let isDragging = false; let startX, startY, translateX=0, translateY=0;
        const img = document.getElementById('lightbox-img'); const modal = document.getElementById('lightbox'); const wrapper = document.getElementById('lb-wrapper');
        function openLightbox(src) { modal.style.display = 'flex'; img.src = src; currentScale=1; translateX=0; translateY=0; updateTransform(); }
        function closeLightbox() { modal.style.display = 'none'; }
        function zoomImage(factor) { currentScale += factor; if(currentScale<0.5)currentScale=0.5; if(currentScale>4)currentScale=4; updateTransform(); }
        function updateTransform() { img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`; }
        wrapper.addEventListener('mousedown', e => { if(currentScale<=1)return; isDragging=true; startX=e.clientX-translateX; startY=e.clientY-translateY; wrapper.style.cursor='grabbing'; e.preventDefault(); });
        window.addEventListener('mouseup', () => { isDragging=false; wrapper.style.cursor='grab'; });
        window.addEventListener('mousemove', e => { if(!isDragging)return; e.preventDefault(); translateX=e.clientX-startX; translateY=e.clientY-startY; updateTransform(); });
        document.addEventListener('keydown', e => { if(e.key === "Escape") { closeLightbox(); closeModal('biModal'); closeModal('infoModal'); } });
        document.getElementById('lightbox').onclick = e => { if(e.target===modal || e.target===wrapper) closeLightbox(); };

        // INIT
        populateFilters();
        renderCatalog(vinhos);
    </script>
</body>
</html>